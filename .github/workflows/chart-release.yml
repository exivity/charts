name: Release Charts

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - feat/github-artifact-attestations
    tags:
      - "exivity-*"

jobs:
  helm-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          helm repo add bitnami https://charts.bitnami.com/bitnami

      - name: Package Charts
        run: |
          mkdir -p .cr-release-packages
          helm package charts/exivity -d .cr-release-packages

          echo "‚úÖ Created chart packages:"
          ls -la .cr-release-packages/

      - name: Create GitHub Attestations
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ".cr-release-packages/*.tgz"

      - name: Verify Attestations
        run: |
          echo "üîç Testing attestation verification..."

          # Verify the chart package
          chart_file=$(ls .cr-release-packages/*.tgz)
          echo "Verifying: $chart_file"
          gh attestation verify "$chart_file" --owner ${{ github.repository_owner }}
          echo "‚úÖ Attestation verified successfully!"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Run chart-releaser
        if: startsWith(github.ref, 'refs/tags/')
        uses: exivity/chart-releaser-action@v1.7.0
        with:
          skip_packaging: true
        env:
          CR_TOKEN: "${{ secrets.GH_BOT_TOKEN }}"
