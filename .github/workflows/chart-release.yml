name: Release Charts

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - feat/github-artifact-attestations
    tags:
      - "exivity-*"

jobs:
  helm-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          helm repo add bitnami https://charts.bitnami.com/bitnami

      - name: Package Charts
        run: |
          mkdir -p .cr-release-packages
          helm package charts/exivity -d .cr-release-packages

          echo "‚úÖ Created chart packages:"
          ls -la .cr-release-packages/

      - name: Create GitHub Attestations
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ".cr-release-packages/*.tgz"

      - name: Verify Attestations
        run: |
          echo "üîç Testing attestation verification..."

          # Install GitHub CLI if not available
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi

          # Verify each chart package
          for chart in .cr-release-packages/*.tgz; do
            echo "Verifying: $chart"
            gh attestation verify "$chart" --owner ${{ github.repository_owner }} || echo "‚ùå Verification failed for $chart"
            echo "‚úÖ Verification completed for $chart"
          done

          echo "üéâ All attestations verified successfully!"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Run chart-releaser
        if: startsWith(github.ref, 'refs/tags/')
        uses: exivity/chart-releaser-action@v1.7.0
        with:
          skip_packaging: true
        env:
          CR_TOKEN: "${{ secrets.GH_BOT_TOKEN }}"
